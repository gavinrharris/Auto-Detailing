<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mobile Detailing SD — Chat</title>
  <style>
    :root{
      --brand:#1253A3;
      --text:#0f172a;
      --muted:#667085;
      --bg:#f4f4f4;
      --card:#ffffff;
      --bot-bubble:#f2f4f7;
      --user-bubble:var(--brand);
      --radius:14px;
    }

    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--bg);
      display:flex;align-items:center;justify-content:center;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Embed mode: fill iframe width/height, no outer chrome */
    body.embed{background:transparent;display:block}
    body.embed #chatbox{max-width:100%;width:100%;height:100%;margin:0;border-radius:0;box-shadow:none;border:0}

    /* Chat card */
    #chatbox{
      width:100%;
      max-width:90%;
      height:70vh;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 8px 28px rgba(0,0,0,.08);
      display:flex;flex-direction:column;overflow:hidden;border:1px solid #e5e7eb;
    }
    @media (max-width:768px){
      #chatbox{max-width:420px;height:90vh}
    }

    /* Header */
    #header{
      background:var(--card);
      border-bottom:1px solid #e5e7eb;
      padding:12px 16px;
      display:flex;align-items:center;justify-content:space-between;
      font-weight:700;
    }
    #status{display:flex;align-items:center;gap:6px;font-weight:600;color:var(--muted);font-size:14px}
    #status-dot{width:10px;height:10px;background:var(--brand);border-radius:50%}

    /* Messages */
    #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#fafafb;scroll-behavior:smooth}
    .row{display:flex}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:78%;padding:10px 12px 6px;border-radius:16px;line-height:1.35;font-size:14px;
      box-shadow:0 1px 1px rgba(0,0,0,.04);white-space:pre-wrap;word-wrap:break-word
    }
    .bot .bubble{background:var(--bot-bubble);color:var(--text)}
    .user .bubble{background:var(--user-bubble);color:#fff}
    .time{display:block;font-size:11px;opacity:.55;margin-top:2px}

    /* Typing dots */
    .typing .bubble{display:inline-flex;align-items:center;gap:6px}
    .dots{display:inline-flex;gap:4px}
    .dots i{width:6px;height:6px;border-radius:999px;background:#9aa4b2;animation:blink 1.2s infinite ease-in-out}
    .dots i:nth-child(2){animation-delay:.15s}
    .dots i:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.25;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}

    /* Composer */
    #inputArea{display:flex;gap:8px;align-items:center;border-top:1px solid #e5e7eb;padding:10px;background:#fff}
    #userInput{flex:1;padding:10px 12px;border:1px solid #ccc;border-radius:12px;font-size:14px}
    #sendBtn{padding:10px 16px;background:var(--brand);color:#fff;border:0;border-radius:12px;font-size:14px;cursor:pointer}
    #sendBtn:hover{opacity:.9}

    *{box-sizing:border-box}
  </style>
</head>
<body>
  <div id="chatbox" role="dialog" aria-label="Mobile Detailing SD Chat">
    <div id="header">
      <span>Mobile Detailing SD</span>
      <div id="status"><span id="status-dot"></span>Online</div>
    </div>

    <div id="messages"></div>

    <div id="inputArea">
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    // 1) Embed mode
    (function(){
      const p=new URLSearchParams(location.search);
      if(p.get('embed')==='1') document.body.classList.add('embed');
    })();

    // 2) Auto-resize: postMessage height to parent (throttled)
    (function(){
      if(window.self===window.top) return; // not inside an iframe
      const post = (h)=> parent.postMessage({type:'MDSD_RESIZE', height:h}, '*');
      let last = 0;
      const ro = new ResizeObserver(entries=>{
        for(const e of entries){
          const h = Math.ceil(e.contentRect.height);
          if(Math.abs(h-last)>4){ last=h; post(h); }
        }
      });
      ro.observe(document.getElementById('chatbox'));
      // also post once after load
      window.addEventListener('load', ()=>post(document.getElementById('chatbox').offsetHeight));
    })();

    // 3) Chat logic with typing dots
    const webhookUrl='https://gavinrharris.app.n8n.cloud/webhook/f343646f-0d88-4128-8667-5520a1385980';
    const $messages=document.getElementById('messages');
    const $input=document.getElementById('userInput');
    const $send=document.getElementById('sendBtn');
    const sessionId=('cb_session_id');
    let sid = localStorage.getItem(sessionId);
    if(!sid){ sid='session_'+Date.now()+'_'+Math.floor(Math.random()*1e6); localStorage.setItem(sessionId,sid); }

    function nowTime(){ return new Date().toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}); }

    function addBubble(text, who='bot'){
      const row=document.createElement('div'); row.className='row '+who;
      const bubble=document.createElement('div'); bubble.className='bubble';
      const msg=document.createElement('div'); msg.textContent=text; bubble.appendChild(msg);
      const ts=document.createElement('span'); ts.className='time'; ts.textContent=nowTime(); bubble.appendChild(ts);
      row.appendChild(bubble); $messages.appendChild(row);
      $messages.scrollTop=$messages.scrollHeight;
    }

    function addTyping(){
      const row=document.createElement('div'); row.className='row bot typing'; row.id='typing-row';
      const bubble=document.createElement('div'); bubble.className='bubble';
      const dots=document.createElement('span'); dots.className='dots'; dots.innerHTML='<i></i><i></i><i></i>';
      bubble.appendChild(dots); row.appendChild(bubble); $messages.appendChild(row);
      $messages.scrollTop=$messages.scrollHeight;
    }
    function removeTyping(){ const t=document.getElementById('typing-row'); if(t) t.remove(); }

    async function sendMessage(){
      const text=$input.value.trim(); if(!text) return;
      addBubble(text,'user'); $input.value=''; $input.focus(); $send.disabled=true;
      addTyping();
      try{
        const res=await fetch(webhookUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,sessionId:sid})});
        const data=await res.json().catch(()=>({reply:'[No response]'}));
        removeTyping();
        addBubble(data.reply || '[No response]','bot');
      }catch(e){
        removeTyping(); addBubble('⚠️ There was an error reaching the server.','bot'); console.error(e);
      }finally{ $send.disabled=false; }
    }

    $send.addEventListener('click',sendMessage);
    $input.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage(); });

    // Initial welcome
    addBubble('Hi there! Would you like to book a detailing appointment or ask a question?','bot');
  </script>
</body>
</html>
